<script setup lang="ts">
import { useWizardStore } from "@/Stores/wizard";
import FileDropZone from "@/Components/FileDropZone.vue";
import { getDocuments } from "./utilities";
import { route } from "ziggy-js";
import type { AxiosResponse } from "axios";

const wizard = useWizardStore();

// Κάνε έλεγχο μήπως έχουμε ήδη ολοκληρώσει το βήμα
wizard.stepCompleted = wizard.documents !== undefined;

const updateDocumentView = async (response: AxiosResponse) => {
    const d = await getDocuments(wizard.documentGroup!.id);

    if (Array.isArray(d.documents)) {
        wizard.documents = d.documents;
        if (wizard.documents!.length > 0) {
            wizard.stepCompleted = true;
        }
    }

    // Έλεγχος για απάντηση 210 (όταν υπήρχαν ήδη αρχεία)
    if (response.status === 210) {
        wizard.confirmationModal.show = true;
        wizard.confirmationModal.title = "Αρχεία ήδη ανεβασμένα";
        wizard.confirmationModal.content = `<p>Τα αρχεία με τα ονόματα:</p><br/><ul class="list-disc"><li>${response.data.existing.join(
            "</li><li>"
        )}</li></ul><br/><p>είχαν ήδη ανέβει στην ομάδα εγγράφων και αγνοήθηκαν. Τα υπόλοιπα αρχεία έχουν ανέβει επιτυχώς.</p>`;
    }
};

const save = () => {
    return new Promise(async (resolve, reject) => {
        resolve("OK");
    });
};

defineExpose({ save });
</script>
<template>
    <div class="flex flex-col bg-white p-4 m-4 rounded items-center">
        <div class="font-bold pb-4 text-xl">
            Βήμα 2ο: Ανέβασμα αρχείων για προσθήκη σφραγίδας
        </div>
        <div class="font-bold">Ήδη ανεβασμένα αρχεία</div>
        <div
            class="flex flex-row h-72 w-full bg-gray-100 rounded shadow-inner items-center justify-center m-3"
        >
            <div class="" v-if="!wizard.documents?.length">
                Δεν έχουν ανέβει αρχεία ακόμη!
            </div>
            <div v-else class="flex flex-col h-72 w-full overflow-y-auto">
                <div
                    v-for="(document, index) in wizard.documents"
                    class="bg-white rounded m-2 p-2 shadow flex flex-row items-center"
                >
                    <div class="flex-grow text-ellipsis">
                        {{ index + 1 }}. {{ document.filename }}
                    </div>
                    <span class="bg-orange-300 p-2 ml-2 rounded shadow">{{
                        document.id
                    }}</span>
                </div>
            </div>
        </div>
        <div class="font-bold">Προσθήκη αρχείων</div>
        <FileDropZone
            :url="route('document.storeMany')"
            @uploaded="updateDocumentView"
            name="documents"
            :append-form-data="{
                document_group_id: `${wizard?.documentGroup?.id}`,
            }"
            @error="wizard.handleAxiosError"
        />
    </div>
</template>
